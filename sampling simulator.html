<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Sampling Distribution & Confidence Interval Simulator</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #f6f9fc;
      margin: 20px;
      color: #333;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
      color: #2c3e50;
    }
    .controls, .charts {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      flex: 1 1 400px;
    }
    label {
      margin-right: 10px;
    }
    input, select {
      margin: 5px 0 15px;
      padding: 5px;
    }
    canvas {
      width: 100% !important;
      height: 350px !important;
    }
    .stats {
      margin-top: 10px;
      font-size: 14px;
      color: #555;
    }
    .ci-legend {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      margin-top: 10px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .legend-color {
      width: 20px;
      height: 10px;
      border-radius: 2px;
    }
  </style>
</head>
<body>
  <h1>Sampling Distribution & Confidence Interval Simulator</h1>

  <div class="controls card">
    <h3>Controls</h3>
    <label>Population:
      <select id="populationSelect">
        <option value="height">Heights (mean=170, sd=10)</option>
        <option value="exam">Exam Scores (mean=70, sd=15)</option>
        <option value="weight">Weights (mean=65, sd=12)</option>
      </select>
    </label><br>

    <label><input type="checkbox" id="showSampling" checked> Show Sampling Distribution</label><br>
    <label><input type="checkbox" id="showCI"> Show Confidence Interval</label><br>

    <label>Sample Size (n): <input type="number" id="sampleSize" value="30" min="1"></label><br>
    <label>Number of Samples: <input type="number" id="numSamples" value="500" min="10"></label><br>
    
    <label>Number of CIs to show: <input type="number" id="numCIs" value="50" min="1" max="100"></label><br>
    <label>Confidence Level (%): <input type="number" id="confidenceLevel" value="95" min="80" max="99"></label><br>

    <label>Animation:
      <select id="animationSelect">
        <option value="none">None</option>
        <option value="mean">Sample Mean Animation</option>
        <option value="variance">Sample Variance Animation</option>
        <option value="both">Mean + Variance Animation</option>
      </select>
    </label><br>

    <button onclick="runSimulation()">Run Simulation</button>
  </div>

  <div class="charts">
    <div class="card" id="populationCard">
      <h3>Population Distribution</h3>
      <canvas id="populationChart"></canvas>
      <div class="stats" id="populationStats"></div>
    </div>

    <div class="card" id="samplingCard" style="display:none;">
      <h3>Sampling Distribution of the Mean</h3>
      <canvas id="samplingChart"></canvas>
      <div class="stats" id="samplingStats"></div>
    </div>

    <div class="card" id="ciCard" style="display:none;">
      <h3>Confidence Interval Simulation</h3>
      <canvas id="ciChart"></canvas>
      <div class="ci-legend">
        <div class="legend-item">
          <div class="legend-color" style="background-color: rgba(76, 175, 80, 0.7);"></div>
          <span>Contains True Mean</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background-color: rgba(244, 67, 54, 0.7);"></div>
          <span>Does Not Contain True Mean</span>
        </div>
      </div>
      <div class="stats" id="ciStats"></div>
    </div>

    <div class="card" id="meanAnimCard" style="display:none;">
      <h3>Sample Mean Animation</h3>
      <canvas id="meanAnimChart"></canvas>
    </div>

    <div class="card" id="varAnimCard" style="display:none;">
      <h3>Sample Variance Animation</h3>
      <canvas id="varAnimChart"></canvas>
    </div>
  </div>

  <script>
    function generatePopulation(size=10000, mean=170, sd=10) {
      let data = [];
      for (let i=0; i<size; i++) {
        let u = Math.random(), v = Math.random();
        let z = Math.sqrt(-2*Math.log(u)) * Math.cos(2*Math.PI*v);
        data.push(mean + sd * z);
      }
      return data;
    }

    function mean(arr) {
      return arr.reduce((a,b)=>a+b,0)/arr.length;
    }

    function variance(arr) {
      let m = mean(arr);
      return arr.reduce((a,b)=>a+(b-m)**2,0)/arr.length;
    }

    function sample(arr, n) {
      let res = [];
      for (let i=0; i<n; i++) {
        res.push(arr[Math.floor(Math.random()*arr.length)]);
      }
      return res;
    }

    function getZScore(confidenceLevel) {
      // Common z-scores for confidence levels
      const zScores = {
        80: 1.282,
        85: 1.440,
        90: 1.645,
        95: 1.960,
        99: 2.576
      };
      return zScores[confidenceLevel] || 1.960; // Default to 95% if not found
    }

    let populationData = [];
    let populationChart, samplingChart, ciChart, meanAnimChart, varAnimChart;

    async function runSimulation() {
      let n = parseInt(document.getElementById("sampleSize").value);
      let numSamples = parseInt(document.getElementById("numSamples").value);
      let numCIs = parseInt(document.getElementById("numCIs").value);
      let confidenceLevel = parseInt(document.getElementById("confidenceLevel").value);
      let showSampling = document.getElementById("showSampling").checked;
      let showCI = document.getElementById("showCI").checked;
      let animChoice = document.getElementById("animationSelect").value;
      let selectedPop = document.getElementById("populationSelect").value;

      // Define population scenarios
      let meanPop, sdPop;
      if (selectedPop === "height") { meanPop = 170; sdPop = 10; }
      else if (selectedPop === "exam") { meanPop = 70; sdPop = 15; }
      else if (selectedPop === "weight") { meanPop = 65; sdPop = 12; }

      populationData = generatePopulation(10000, meanPop, sdPop);

      // Population stats
      let popMean = mean(populationData).toFixed(2);
      let popVar = variance(populationData).toFixed(2);
      document.getElementById("populationStats").innerText = 
        `Mean = ${popMean}, Variance = ${popVar}`;

      // Population histogram
      let bins = 40;
      let minX = Math.min(...populationData), maxX = Math.max(...populationData);
      let step = (maxX-minX)/bins;
      let binLabels = Array.from({length:bins},(_,i)=>(minX+i*step).toFixed(1));
      let popCounts = new Array(bins).fill(0);
      populationData.forEach(x=>{
        let idx = Math.floor((x-minX)/step);
        if (idx>=0 && idx<bins) popCounts[idx]++;
      });

      if (populationChart) populationChart.destroy();
      populationChart = new Chart(document.getElementById("populationChart"), {
        type:'bar',
        data:{
          labels:binLabels,
          datasets:[{label:"Population",data:popCounts,backgroundColor:"rgba(54,162,235,0.6)"}]
        },
        options:{scales:{y:{beginAtZero:true}}}
      });

      // Sampling Distribution
      if (showSampling) {
        document.getElementById("samplingCard").style.display="block";
        let sampleMeans=[];
        for (let i=0;i<numSamples;i++){
          sampleMeans.push(mean(sample(populationData,n)));
        }
        let smMean=mean(sampleMeans).toFixed(2);
        let smVar=variance(sampleMeans).toFixed(2);
        document.getElementById("samplingStats").innerText = 
          `Mean = ${smMean}, Variance = ${smVar}`;

        let bins2 = 40;
        let minX2 = Math.min(...sampleMeans), maxX2 = Math.max(...sampleMeans);
        let step2 = (maxX2-minX2)/bins2;
        let binLabels2 = Array.from({length:bins2},(_,i) => (minX2+i*step2).toFixed(2));
        let smCounts = new Array(bins2).fill(0);
        sampleMeans.forEach(x=>{
          let idx = Math.floor((x-minX2)/step2);
          if (idx>=0 && idx<bins2) smCounts[idx]++;
        });

        if (samplingChart) samplingChart.destroy();
        samplingChart = new Chart(document.getElementById("samplingChart"), {
          type:'bar',
          data:{
            labels:binLabels2,
            datasets:[{label:"Sample Means",data:smCounts,backgroundColor:"rgba(75,192,192,0.6)"}]
          },
          options:{scales:{y:{beginAtZero:true}}}
        });
      } else {
        document.getElementById("samplingCard").style.display="none";
      }

      // Confidence Interval Simulation
      if (showCI) {
        document.getElementById("ciCard").style.display="block";
        let ciData = [];
        let containsCount=0;
        let trueMean = mean(populationData);
        let zScore = getZScore(confidenceLevel);

        for (let i=0;i<numCIs;i++){
          let samp = sample(populationData,n);
          let m = mean(samp);
          let s = Math.sqrt(variance(samp));
          let se = s/Math.sqrt(n);
          let margin = zScore*se;
          let lower = m-margin, upper=m+margin;
          let containsTrueMean = lower<=trueMean && upper>=trueMean;
          if (containsTrueMean) containsCount++;
          ciData.push({m,lower,upper,containsTrueMean});
        }

        if (ciChart) ciChart.destroy();
        
        // Create datasets for confidence intervals
        const ciDatasets = [];
        
        // Add true mean line
        ciDatasets.push({
          label: 'True Population Mean',
          data: Array.from({length: numCIs}, (_, i) => ({x: i+1, y: trueMean})),
          borderColor: 'rgba(33, 150, 243, 0.8)',
          borderWidth: 2,
          borderDash: [5, 5],
          pointRadius: 0,
          fill: false
        });

        // Add confidence intervals as vertical error bars
        ciData.forEach((d, i) => {
          ciDatasets.push({
            label: `CI ${i+1}`,
            data: [
              {x: i+1, y: d.lower},
              {x: i+1, y: d.upper}
            ],
            borderColor: d.containsTrueMean ? 'rgba(76, 175, 80, 0.8)' : 'rgba(244, 67, 54, 0.8)',
            borderWidth: 2,
            pointRadius: 0,
            fill: false
          });
        });

        // Add sample means as points
        ciDatasets.push({
          label: 'Sample Means',
          data: ciData.map((d, i) => ({
            x: i+1,
            y: d.m
          })),
          backgroundColor: ciData.map(d => 
            d.containsTrueMean ? 'rgba(76, 175, 80, 1)' : 'rgba(244, 67, 54, 1)'),
          borderColor: ciData.map(d => 
            d.containsTrueMean ? 'rgba(76, 175, 80, 1)' : 'rgba(244, 67, 54, 1)'),
          borderWidth: 1,
          pointRadius: 3,
          pointHoverRadius: 5,
          showLine: false
        });

        ciChart = new Chart(document.getElementById("ciChart"), {
          type:'line',
          data:{
            datasets: ciDatasets
          },
          options:{
            responsive: true,
            scales: {
              x: {
                type: 'linear',
                title: {
                  display: true,
                  text: 'Sample Number'
                },
                min: 0.5,
                max: numCIs + 0.5,
                ticks: {
                  stepSize: 1
                }
              },
              y: {
                title: {
                  display: true,
                  text: 'Value'
                },
                beginAtZero: false
              }
            },
            plugins: {
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const datasetLabel = context.dataset.label;
                    if (datasetLabel === 'Sample Means') {
                      const d = ciData[context.dataIndex];
                      return [
                        `Sample Mean: ${d.m.toFixed(2)}`,
                        `CI: [${d.lower.toFixed(2)}, ${d.upper.toFixed(2)}]`,
                        `Width: ${(d.upper - d.lower).toFixed(2)}`,
                        `Contains true mean: ${d.containsTrueMean ? 'Yes' : 'No'}`
                      ];
                    } else if (datasetLabel === 'True Population Mean') {
                      return `True Mean: ${trueMean.toFixed(2)}`;
                    }
                    return context.formattedValue;
                  }
                }
              },
              legend: {
                display: false
              }
            }
          }
        });

        document.getElementById("ciStats").innerText =
          `${containsCount}/${numCIs} CIs contain the true mean (${trueMean.toFixed(2)}) - ${(containsCount/numCIs*100).toFixed(1)}% (Expected: ${confidenceLevel}%)`;

      } else {
        document.getElementById("ciCard").style.display="none";
      }

      // ------------------------
      // Animation Section
      // ------------------------
      document.getElementById("meanAnimCard").style.display = (animChoice==="mean"||animChoice==="both")?"block":"none";
      document.getElementById("varAnimCard").style.display = (animChoice==="variance"||animChoice==="both")?"block":"none";

      if (animChoice!=="none") {
        let ctxMean = document.getElementById('meanAnimChart').getContext('2d');
        if (meanAnimChart) meanAnimChart.destroy();
        meanAnimChart = new Chart(ctxMean, {
          type:'line',
          data:{labels:[],datasets:[
            {label:'Average Sample Mean',data:[],borderColor:'green',fill:false},
            {label:`Population Mean (${meanPop})`,data:[],borderColor:'orange',borderDash:[5,5],fill:false,pointRadius:0}
          ]},
          options:{animation:false,scales:{y:{title:{display:true,text:'Mean'}}}}
        });

        let ctxVar = document.getElementById('varAnimChart').getContext('2d');
        if (varAnimChart) varAnimChart.destroy();
        varAnimChart = new Chart(ctxVar, {
          type:'line',
          data:{labels:[],datasets:[
            {label:'Average Sample Variance',data:[],borderColor:'blue',fill:false},
            {label:`Population Variance (${popVar})`,data:[],borderColor:'red',borderDash:[5,5],fill:false,pointRadius:0}
          ]},
          options:{animation:false,scales:{y:{title:{display:true,text:'Variance'}}}}
        });

        let cumulativeMean=0, cumulativeVar=0;

        for (let i=1;i<=numSamples;i++){
          let samp = sample(populationData,n);
          let m = mean(samp);
          let v = variance(samp);
          cumulativeMean+=m;
          cumulativeVar+=v;
          let avgMean=cumulativeMean/i;
          let avgVar=cumulativeVar/i;

          if (animChoice==="mean"||animChoice==="both") {
            meanAnimChart.data.labels.push(i);
            meanAnimChart.data.datasets[0].data.push(avgMean);
            meanAnimChart.data.datasets[1].data.push(meanPop);
            meanAnimChart.update();
          }
          if (animChoice==="variance"||animChoice==="both") {
            varAnimChart.data.labels.push(i);
            varAnimChart.data.datasets[0].data.push(avgVar);
            varAnimChart.data.datasets[1].data.push(popVar);
            varAnimChart.update();
          }
          if (i<200) await new Promise(r=>setTimeout(r,15));
        }
      }
    }

    runSimulation();
  </script>
</body>
</html>
